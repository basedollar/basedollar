type Collateral @entity(immutable: true) {
  id: ID! # "type:collIndex", e.g. "r:0" or "n:0"
  collIndex: Int!
  minCollRatio: BigInt!
  redeemable: Boolean!
  isAeroLPCollateral: Boolean!
  aeroGauge: AeroGauge @derivedFrom(field: "collateral") # Used for AeroManager events attribution.
  troves: [Trove!]! @derivedFrom(field: "collateral")
  addresses: CollateralAddresses! @derivedFrom(field: "collateral")
}

type CollateralAddresses @entity(immutable: false) {
  id: ID! # "type:collIndex", e.g. "r:0" or "n:0"
  collateral: Collateral!
  borrowerOperations: Bytes!
  sortedTroves: Bytes!
  stabilityPool: Bytes!
  activePool: Bytes!
  token: Bytes!
  troveManager: Bytes!
  troveNft: Bytes!
  collSurplusPool: Bytes
  aeroGauge: Bytes
}

type AeroGauge @entity(immutable: false) {
  id: ID! # "gaugeAddress", e.g. "0x0000000000000000000000000000000000000000"
  collateral: Collateral!
  gauge: Bytes!
  token: Bytes!
  activePool: Bytes!
  aeroManager: Bytes!
}

# Raw AeroManager staking events, attributed to a branch via the calling ActivePool.
type AeroStake @entity(immutable: true) {
  id: ID! # txHash:logIndex
  collateral: Collateral!
  activePool: Bytes!
  gauge: Bytes!
  token: Bytes!
  amount: BigInt!
  blockNumber: BigInt!
  timestamp: BigInt!
  transactionHash: Bytes!
}

# Raw AeroManager claimed events, attributed to a branch via the calling ActivePool.
type AeroClaim @entity(immutable: true) {
  id: ID! # txHash:logIndex
  collateral: Collateral!
  activePool: Bytes!
  gauge: Bytes!
  total: BigInt!
  claimFee: BigInt!
  blockNumber: BigInt!
  timestamp: BigInt!
  transactionHash: Bytes!
}

type InterestRateBracket @entity(immutable: false) {
  id: ID! # "type:collIndex:rateFloored", e.g. "r:0:44000000000000000" or "n:0:44000000000000000"
  collateral: Collateral!
  rate: BigInt!
  totalDebt: BigInt!
  sumDebtTimesRateD36: BigInt!
  pendingDebtTimesOneYearD36: BigInt!
  updatedAt: BigInt!
}

enum TroveStatus {
  active
  closed
  liquidated
  redeemed
}

type Trove @entity(immutable: false) {
  id: ID! # "type:collIndex:collId", e.g. "r:0:0x1731afc858cad2708001a4f71851f9f775729c22f47df7c4360b1e416fd0f2de" or "n:0:0x1731afc858cad2708001a4f71851f9f775729c22f47df7c4360b1e416fd0f2de"
  borrower: Bytes!
  collateral: Collateral!
  closedAt: BigInt
  createdAt: BigInt!
  mightBeLeveraged: Boolean!
  status: TroveStatus!
  updatedAt: BigInt!
  lastUserActionAt: BigInt!
  debt: BigInt!
  deposit: BigInt!
  interestBatch: InterestBatch
  interestRate: BigInt!
  stake: BigInt!
  troveId: String!
  previousOwner: Bytes!
  redemptionCount: Int!
  redeemedColl: BigInt!
  redeemedDebt: BigInt!
  liquidatedColl: BigInt
  liquidatedDebt: BigInt
  collSurplus: BigInt
  priceAtLiquidation: BigInt
}

type TroveSnapshot @entity(immutable: true) {
  id: ID! # "type:collIndex:troveId:timestamp", e.g. "r:0:0x1731afc858cad2708001a4f71851f9f775729c22f47df7c4360b1e416fd0f2de:1715702400" or "n:0:0x1731afc858cad2708001a4f71851f9f775729c22f47df7c4360b1e416fd0f2de:1715702400"
  trove: Trove!
  collateral: Collateral!
  interestBatch: InterestBatch
  status: TroveStatus!
  borrower: Bytes!
  debt: BigInt!
  deposit: BigInt!
  stake: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type BorrowerInfo @entity(immutable: false) {
  id: ID! # "borrowerAddress", e.g. "0x0000000000000000000000000000000000000000"
  nextOwnerIndexes: [Int!]!
  troves: Int!
  trovesByCollateral: [Int!]!
  collSurplusBalance: [BigInt!]!
  lastCollSurplusClaimAt: [BigInt!]! # a zero element means a claim has never been made in that branch
}

type InterestBatch @entity(immutable: false) {
  id: ID! # "type:collIndex:batchManager", e.g. "r:0:0x0000000000000000000000000000000000000000" or "n:0:0x0000000000000000000000000000000000000000"
  collateral: Collateral!
  batchManager: Bytes!
  debt: BigInt!
  coll: BigInt!
  annualInterestRate: BigInt!
  annualManagementFee: BigInt!
  updatedAt: BigInt!
  troves: [Trove!]! @derivedFrom(field: "interestBatch")
}

type GovernanceVotingPower @entity(immutable: false) {
  id: ID! # userAddress, e.g. "0x0000000000000000000000000000000000000000", or "total"
  allocatedLQTY: BigInt!
  allocatedOffset: BigInt!
  unallocatedLQTY: BigInt!
  unallocatedOffset: BigInt!
}

type GovernanceAllocationIndex @entity(immutable: false) {
  id: ID! # "userAddress:initiativeAddress" or "initiativeAddress"
  user: String
  initiative: GovernanceInitiative!
  latestAllocation: GovernanceAllocation!
}

type GovernanceAllocation @entity(immutable: false) {
  id: ID! # "userAddress:initiativeAddress:epoch" or "initiativeAddress:epoch"
  user: String
  initiative: GovernanceInitiative!
  epoch: BigInt!
  voteLQTY: BigInt!
  vetoLQTY: BigInt!
  voteOffset: BigInt!
  vetoOffset: BigInt!
}

type GovernanceInitiative @entity(immutable: false) {
  id: ID! # "initiativeAddress", e.g. "0x0000000000000000000000000000000000000000"
  registered: Boolean!
}
